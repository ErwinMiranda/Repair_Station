<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mabilis Load</title>
  <script src="auth.js"></script>
  <script>
  requireLogin();
 </script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td { padding: 6px; border: 1px solid #ddd; font-size: 14px; text-align: left; }
    thead th { background: #f5f5f5; position: sticky; top: 0; z-index: 2; }
    thead input {
      width: 95%;
      padding: 2px;
      font-size: 12px;
      box-sizing: border-box;
    }
    .clusterize-scroll {
      height: 500px;
      overflow-y: auto;
      border: 1px solid #aaa;
    }
    #counter { margin-bottom: 10px; font-weight: bold; margin-top: 10px; }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 18px;
      color: #333;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #loadingOverlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #loadingOverlay .spinner {
      border: 4px solid #ccc;
      border-top: 4px solid #0078d7;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h2>Wan MTC</h2>
  <div>
    <input type="text" id="woInput" placeholder="Enter Workorder ">
    <button id="woSearchBtn">Search</button>
  </div>
  <div id="counter">Waiting for input...</div>

  <div id="scrollArea" class="clusterize-scroll">
    <table>
      <thead>
        <tr>
          <th style="width:15%;">TaskCard</th>
          <th style="width:15%;">Reference</th>
          <th style="width:25%;">Description</th>
          <th style="width:10%;">Seq.No</th>
          <th style="width:10%;">Skill</th>
          <th style="width:10%;">Phase</th>
          <th style="width:15%;">Status</th>
        </tr>
        <tr>
          <th><input type="text" class="filter" data-field="task_card" placeholder="Search TaskCard"></th>
          <th><input type="text" class="filter" data-field="reference_task_card" placeholder="Search Reference"></th>
          <th><input type="text" class="filter" data-field="task_card_description" placeholder="Search Description"></th>
          <th><input type="text" class="filter" data-field="seq" placeholder="Search Seq"></th>
          <th><input type="text" class="filter" data-field="skill" placeholder="Search Skill"></th>
          <th><input type="text" class="filter" data-field="phase" placeholder="Search Phase"></th>
          <th><input type="text" class="filter" data-field="status" placeholder="Search Status"></th>
        </tr>
      </thead>
      <tbody id="contentArea" class="clusterize-content">
        <tr class="clusterize-no-data"><td colspan="7">No data yet</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" style="display:none;">
    <div class="spinner"></div>
    Loading data...
  </div>

  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
  <script type="module">
    const SESSION_KEY = "demo_session";
    const savedSession = JSON.parse(localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY));

    if (!savedSession) {
      location.href = "index.html"; // not logged in
    } else {
        // Role-based access check
      const page = location.pathname.split("/").pop(); // current file name
      if (savedSession.page !== page) {
        location.href = "index.html"; // redirect if wrong user for this page
      }
      }
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = { 
      apiKey: "AIzaSyDCpHhUL8x4rs-fom1xyaNdWm5prSGf57U",
      authDomain: "onemtc-2222c.firebaseapp.com",
      projectId: "onemtc-2222c",
      storageBucket: "onemtc-2222c.firebasestorage.app",
      messagingSenderId: "447271556426",
      appId: "1:447271556426:web:562ba4d72e40b754599db3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    signInAnonymously(auth);

    const clusterize = new Clusterize({
      scrollId: 'scrollArea',
      contentId: 'contentArea',
      rows: []
    });

    const counterEl = document.getElementById("counter");
    const woInput = document.getElementById("woInput");
    const woSearchBtn = document.getElementById("woSearchBtn");
    const overlay = document.getElementById("loadingOverlay");

    let unsubscribe = null; 
    let allDocs = []; // store all docs for filtering

    function showLoading() { overlay.style.display = "flex"; }
    function hideLoading() { overlay.style.display = "none"; }

    function renderRows(docs) {
      let rows = docs.map(d => `
        <tr id="row-${d.id}">
          <td>${d.task_card || ''}</td>
          <td>${d.reference_task_card || ''}</td>
          <td>${d.task_card_description || ''}</td>
          <td>${d.seq || ''}</td>
          <td>${d.skill || ''}</td>
          <td>${d.phase || ''}</td>
          <td>${d.status || ''}</td>
        </tr>
      `);
      clusterize.update(rows);
    }

    function applyFilters() {
      const filters = {};
      document.querySelectorAll(".filter").forEach(input => {
        if (input.value.trim() !== "") {
          filters[input.dataset.field] = input.value.toLowerCase();
        }
      });

      let filtered = allDocs.filter(d => {
        return Object.keys(filters).every(field => {
          return (d[field] || "").toString().toLowerCase().includes(filters[field]);
        });
      });

      renderRows(filtered);
      counterEl.textContent = `Showing ${filtered.length} of ${allDocs.length} tasks`;
    }

    document.querySelectorAll(".filter").forEach(input => {
      input.addEventListener("input", applyFilters);
    });

    function searchWorkorder(wo) {
      if (!wo) return;
      showLoading();
      counterEl.textContent = "Loading tasks...";

      localStorage.setItem("lastWorkorder", wo);
      if (unsubscribe) unsubscribe();

      let woValue = isNaN(wo) ? wo : Number(wo);

      const q = query(collection(db, "tasks"), where("wo", "==", woValue));
      unsubscribe = onSnapshot(q, (snapshot) => {
        allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        counterEl.textContent = `Total Tasks: ${snapshot.size}`;
        renderRows(allDocs);
        hideLoading();
      });
    }

    woSearchBtn.addEventListener("click", () => {
      const wo = woInput.value.trim();
      if (wo) searchWorkorder(wo);
    });

    const lastWO = localStorage.getItem("lastWorkorder");
    if (lastWO) {
      woInput.value = lastWO;
      searchWorkorder(lastWO);
    }
  </script>
</body>
</html>
