<!doctype html>
<html lang="en">
<head>
  <script src="auth.js"></script>
  <script>
  requireLogin();
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Real-time Excel → Firestore (Tasks)</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { max-width:1100px; margin:18px auto; padding:18px; }
    h1 { margin:0 0 8px 0; font-size:20px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:12px 0; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #bbb; background:#f5f5f5; cursor:pointer; }
    button.primary { background:#0b74de; color:white; border-color:#0a66c2; }
    button.danger { background:#ffe6e6; border-color:#ff8b8b; }
    input[type=file] { padding:6px; }
    .status { margin-left:6px; color:#333; font-size:13px; }
    #tasksTable { width:100%; border-collapse:collapse; margin-top:12px; max-height:520px; overflow:auto; display:block; }
    #tasksTable thead { background:#fafafa; position:sticky; top:0; z-index:2; }
    #tasksTable th, #tasksTable td { padding:6px 8px; border:1px solid #eee; text-align:left; font-size:13px; }
    #tasksTable tbody tr:nth-child(odd) { background:#fff; }
    #tasksTable tbody tr:nth-child(even) { background:#fbfbfb; }
    .small { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <div <button onclick="logout()" class="logout-btn">Logout</button> </div>  
  <h1>Real-time Excel → Firestore (Tasks)</h1>
  <div class="small">Uploads Excel rows to Firestore (collection: <code>tasks</code>) using <code>taskid</code> as document ID. Live updates via Firestore onSnapshot.</div>

  <div class="controls">
    <input id="file" type="file" accept=".xlsx,.xls,.csv" />
    <button id="uploadBtn" class="primary">Upload to Firestore</button>
    <label for="workorderSelect">Select Workorder:</label>
    <select id="workorderSelect"></select>
    <button id="deleteWorkorderBtn" class="danger">Delete Workorder</button>
    <label style="margin-left:8px"><input id="useRemote" type="checkbox" checked /> Use Firestore (remote)</label>
    <span class="status" id="status">Initializing Firebase...</span>
  </div>

  <div style="flex:1 1 100%;">
    <table id="tasksTable" aria-label="Tasks table">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="tasksBody">
        <tr><td colspan="12" class="small">No tasks loaded yet.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- SheetJS for parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script 
      const SESSION_KEY = "demo_session";
  const savedSession = JSON.parse(localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY));

  if (!savedSession) {
    location.href = "index.html"; // not logged in
  } else {
    // Role-based access check
    const page = location.pathname.split("/").pop(); // current file name
    if (savedSession.page !== page) {
      location.href = "index.html"; // redirect if wrong user for this page
    }
  }
    type="module">
     import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, writeBatch, onSnapshot, query, where, orderBy, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUNjFesHA_nMEsULylFlEdNZHy-MlT7_o",
      authDomain: "webmilestoneplan.firebaseapp.com",
      projectId: "webmilestoneplan",
      storageBucket: "webmilestoneplan.firebasestorage.app",
      messagingSenderId: "757067401738",
      appId: "1:757067401738:web:697d0440b4aa7264562df3"
    };

    let app, db, auth;
    let firebaseReady = false;

    const fileInput = document.getElementById('file');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusSpan = document.getElementById('status');
    const tasksBody = document.getElementById('tasksBody');
    const headerRow = document.getElementById('headerRow');
    const useRemote = document.getElementById('useRemote');

    const TASKS_COLLECTION = 'tasks';
    const BATCH_LIMIT = 400;

    function setStatus(msg, isError=false){
      statusSpan.textContent = msg;
      statusSpan.style.color = isError ? 'crimson' : '#333';
    }

    function normalizeDate(value){
      if(value == null) return null;
      if(Object.prototype.toString.call(value) === '[object Date]'){
        if(isNaN(value)) return null;
        const y = value.getFullYear();
        const m = String(value.getMonth()+1).padStart(2,'0');
        const d = String(value.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      }
      if(typeof value === 'number'){
        const excelEpoch = new Date(1899,11,30);
        const dt = new Date(excelEpoch.getTime() + value * 86400000);
        return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      }
      const maybe = new Date(value);
      if(!isNaN(maybe)) {
        return `${maybe.getFullYear()}-${String(maybe.getMonth()+1).padStart(2,'0')}-${String(maybe.getDate()).padStart(2,'0')}`;
      }
      return String(value);
    }

    async function parseFileToRows(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });
            resolve(rows);
          } catch (err) { reject(err); }
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    function mapRow(raw){
      const mapKey = (names) => {
        const keys = Object.keys(raw);
        for(const n of names){
          const found = keys.find(k => k.trim().toLowerCase() === n.toLowerCase());
          if(found) return found;
        }
        return null;
      };
      return {
        taskid: raw[mapKey(['taskid','task id','id'])] ?? null,
        skill: raw[mapKey(['skill'])] ?? null,
        sdate: normalizeDate(raw[mapKey(['sdate','start','start date'])] ?? null),
        edate: normalizeDate(raw[mapKey(['edate','end','end date'])] ?? null),
        rev_sdate: normalizeDate(raw[mapKey(['rev_sdate','rev sdate','rev start'])] ?? null),
        rev_edate: normalizeDate(raw[mapKey(['rev_edate','rev edate','rev end'])] ?? null),
        tasktitle: raw[mapKey(['tasktitle','task title','title'])] ?? null,
        remarks: raw[mapKey(['remarks'])] ?? null,
        status: raw[mapKey(['status'])] ?? null,
        acreg: raw[mapKey(['acreg','aircraft','ac reg'])] ?? null,
        workorder: raw[mapKey(['workorder','work order','wo'])] ?? null,
        bay: raw[mapKey(['bay'])] ?? null
      };
    }

    const HEADER_LABELS = {
      taskid: "Task ID", skill: "Skill", sdate: "Start Date", edate: "End Date",
      rev_sdate: "Revised Start", rev_edate: "Revised End", tasktitle: "Task Title",
      remarks: "Remarks", status: "Status", acreg: "AC Reg", workorder: "Work Order", bay: "Bay"
    };

    function renderTable(rows) {
      const headers = Object.keys(HEADER_LABELS);
      rows = [...rows].sort((a, b) => new Date(a.sdate||"2100-01-01") - new Date(b.sdate||"2100-01-01"));
      headerRow.innerHTML = '';
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = HEADER_LABELS[h];
        headerRow.appendChild(th);
      });
      tasksBody.innerHTML = '';
      if (!rows.length) {
        tasksBody.innerHTML = `<tr><td colspan="${headers.length}" class="small">No tasks found.</td></tr>`;
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = r[h] ?? '';
          if (h === 'bay' && !r[h]) {
            td.style.backgroundColor = '#ffe6e6'; td.style.color = '#a00'; td.textContent = '(missing)';
          }
          tr.appendChild(td);
        });
        tasksBody.appendChild(tr);
        populateWorkorderDropdown();
      });
    }

    async function uploadRowsToFirestore(mappedRows){
      if(!firebaseReady) throw new Error('Firebase not ready');
      const chunks = [];
      for(let i=0;i<mappedRows.length;i+=BATCH_LIMIT) chunks.push(mappedRows.slice(i,i+BATCH_LIMIT));
      for(const chunk of chunks){
        const batch = writeBatch(db);
        for(const row of chunk){
          batch.set(doc(db, TASKS_COLLECTION, String(row.taskid)), { ...row, updatedAt: serverTimestamp() });
        }
        await batch.commit();
      }
      setStatus("Upload complete");
    }

    function attachRealtimeListener(){
      const q = query(collection(db, TASKS_COLLECTION), orderBy('sdate'));
      onSnapshot(q, snapshot => {
        const rows = [];
        snapshot.forEach(docSnap => rows.push(docSnap.data()));
        renderTable(rows);
        setStatus(`Realtime: ${rows.length} tasks`);
      }, err => setStatus("Listener error: " + err.message, true));
    }

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files?.[0];
      if(!file) return setStatus("Select file", true);
      const rows = (await parseFileToRows(file)).map(r => mapRow(r));
      if(useRemote.checked) await uploadRowsToFirestore(rows);
      else setStatus("Remote disabled (no upload)");
    });

    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      signInAnonymously(auth)
        .then(() => {
          setStatus("Signed in (anonymous)");
          firebaseReady = true;
          attachRealtimeListener();
        })
        .catch(err => setStatus("Auth failed: " + err.message, true));
    } catch (e) {
      setStatus("Firebase init failed: " + e.message, true);
    }

    async function populateWorkorderDropdown() {
      const snap = await getDocs(collection(db, TASKS_COLLECTION));
      const workorders = new Set();

      snap.forEach(d => {
        if (d.data().workorder !== undefined && d.data().workorder !== null) {
          workorders.add(d.data().workorder);
        }
      });

      const select = document.getElementById('workorderSelect');
      select.innerHTML = "";

      if (workorders.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No workorders found";
        select.appendChild(opt);
        select.disabled = true;
      } else {
        workorders.forEach(wo => {
          const opt = document.createElement("option");
          opt.value = wo;
          opt.textContent = wo;
          select.appendChild(opt);
        });
        select.disabled = false;
      }
    }
    populateWorkorderDropdown();

    deleteWorkorderBtn.addEventListener('click', async () => {
      const select = document.getElementById('workorderSelect');
      let workorder = select.value;

      if (!workorder) {
        return setStatus("Please select a workorder", true);
      }

      let q = query(collection(db, TASKS_COLLECTION), where("workorder", "==", workorder));
      let snap = await getDocs(q);

      if (snap.empty && !isNaN(workorder)) {
        q = query(collection(db, TASKS_COLLECTION), where("workorder", "==", Number(workorder)));
        snap = await getDocs(q);
      }

      if (snap.empty) {
        return setStatus(`No tasks found for Workorder "${workorder}"`, true);
      }

      const docs = snap.docs;
      const count = docs.length;

      if (!confirm(`Delete ${count} task(s) for Workorder "${workorder}"?`)) return;

      for (let i = 0; i < docs.length; i += BATCH_LIMIT) {
        const batch = writeBatch(db);
        docs.slice(i, i + BATCH_LIMIT).forEach(d => batch.delete(d.ref));
        await batch.commit();
      }

      setStatus(`Deleted ${count} task(s) for Workorder "${workorder}"`);
      populateWorkorderDropdown();
    });

  </script>
</body>
</html>
